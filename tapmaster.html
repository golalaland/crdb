<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Tap Master</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Montserrat:wght@500;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#0e0e0e;
  --glass-bg: rgba(255,255,255,0.04);
  --accent1:#FF1493;
  --accent2:#FF8C00;
  --green1:#00e676;
  --muted:#aaa;
  --glass-border: rgba(255,255,255,0.08);
}

*{box-sizing:border-box}
html,body {height:100%;margin:0;background:var(--bg);color:#fff;font-family:'Montserrat',sans-serif; -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
body {display:flex;justify-content:center;align-items:flex-start;padding:18px 0 120px; touch-action:manipulation; -webkit-tap-highlight-color: transparent; overflow-x:hidden;}
#appWrapper {width:100%;max-width:480px;display:flex;flex-direction:column;align-items:center;}

/* header */
#gameHeader{text-align:center;margin-top:6px;}
#welcomeText{font-family:'Press Start 2P',cursive;font-size:11px;color:var(--accent1)}
#scrambleText{font-family:'Press Start 2P',cursive;font-size:20px;color:var(--accent1);margin-top:4px}

/* glass terminal (tap stats + timer etc) */
.glass-terminal {
  width: 90%;
  max-width: 420px;
  margin: 18px auto;
  padding: 14px 16px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: 14px;
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  box-shadow: 0 0 20px rgba(0,0,0,0.6);
  color: #fff;
  position: relative;
  overflow: hidden;
}
.terminal-header { text-align:center; color:var(--accent1); font-size:11px; letter-spacing:2px; margin-bottom:8px; font-weight:700; }
.terminal-line { font-size:13px; line-height:1.6; letter-spacing:1px; color:#fff; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
.terminal-line span { color:#00FF99; text-shadow:0 0 6px rgba(0,255,153,0.08); font-weight:700; }

/* train bar (timer visual) */
#trainBarContainer {
  width:100%;
  height:14px;
  background: rgba(255,255,255,0.03);
  border-radius: 999px;
  overflow:hidden;
  margin-top:8px;
}
#trainBar {
  height:100%;
  width:100%;
  background: linear-gradient(90deg, var(--accent1), var(--accent2));
  transform-origin: left center;
  transition: width 0.2s linear;
}

/* stats row inside terminal */
.stats-row { display:flex; justify-content:space-between; gap:12px; margin-top:8px; align-items:center; }
.stat { flex:1; background: rgba(255,255,255,0.02); padding:8px; border-radius:8px; text-align:center; }
.stat .label { font-size:11px; color:var(--muted); }
.stat .value { font-size:16px; font-weight:800; color:#fff; }

/* bonus bar (progress toward next bonus level) */
#bonusContainer { width:100%; height:10px; background:#111; border-radius:999px; overflow:hidden; margin-top:12px; box-shadow:0 6px 16px rgba(0,0,0,0.6) inset; }
#bonusBar { height:100%; width:0%; background:linear-gradient(90deg,var(--green1),#00b0ff); transition:width .15s linear; }

/* TAP button - small round, far from terminal */
#tapButton {
  width:64px;
  height:64px;
  border-radius:50%;
  background: radial-gradient(circle at 25% 25%, var(--green1), #00b0ff);
  border: none;
  margin-top:36px; /* far from terminal */
  box-shadow: 0 8px 30px rgba(0,230,118,0.14);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  color:#000;
  font-size:18px;
  -webkit-user-select:none;
  user-select:none;
  -webkit-tap-highlight-color: transparent;
}

/* tap hover/active */
#tapButton:active { transform: scale(.96); }

/* tap count + earnings small status (below button) */
#miniStats { margin-top:12px; color:#fff; font-weight:700; }

/* leaderboard button */
#leaderboardBtn {
  margin-top:14px;
  padding:10px 14px;
  border-radius:10px;
  background: linear-gradient(90deg,#FFD700,#FF8C00);
  color:#111;
  font-weight:800;
  border:none;
  cursor:pointer;
  font-size:14px;
}

/* modal (normal fade-in centered) */
.modal-backdrop {
  position:fixed; inset:0; background: rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:9999;
}
.modal {
  width:92%; max-width:420px; background:#0f0f0f; border-radius:12px; padding:16px; border:1px solid rgba(255,255,255,0.06);
  box-shadow: 0 10px 30px rgba(0,0,0,0.6);
}
.modal h3{ margin:0 0 8px 0; color:var(--accent1); font-size:16px; }
.modal .list { text-align:left; margin-top:12px; max-height:320px; overflow:auto; }
.modal .list li { padding:8px 6px; border-bottom:1px dashed rgba(255,255,255,0.03); font-weight:700; }

/* result panel (small) */
#resultModalInner { display:none; margin-top:18px; }

/* small helpers */
.hidden { display:none!important; }
button, input { font-size:16px; } /* prevents iOS zoom on tap */
</style>
</head>
<body>
<div id="appWrapper">

  <!-- Header -->
  <div id="gameHeader">
    <div id="welcomeText">WELCOME TO</div>
    <div id="scrambleText">TAP MASTER</div>
  </div>
  

<!-- Start Page -->
<div id="startPage" style="width:100%;display:flex;flex-direction:column;align-items:center;margin-top:18px;">
  <button id="startBtn" style="padding:12px 22px;border-radius:12px;background:linear-gradient(90deg,#00e676,#00b0ff);color:#000;font-weight:800;font-size:16px;border:none;cursor:pointer;">Play</button>
  <img id="posterImg" src="https://via.placeholder.com/420x200?text=Poster+Here" alt="Poster" style="width:90%;max-width:420px;margin:12px auto;border-radius:12px;">
</div>

<!-- Play Confirmation Modal -->
<div id="playModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:2000;justify-content:center;align-items:center;display:flex;">
  <div style="background:#111;color:#fff;padding:20px;border-radius:12px;width:90%;max-width:320px;text-align:center;">
    <h3 style="margin-bottom:12px;">Confirm Play</h3>
    <p>Spend <strong>10 ‚≠ê</strong> to start this game?</p>
    <div style="display:flex;justify-content:space-between;margin-top:18px;">
      <button id="cancelPlay" style="flex:1;margin-right:6px;padding:10px 12px;border:none;border-radius:8px;background:#444;color:#fff;font-weight:700;cursor:pointer;">Cancel</button>
      <button id="confirmPlay" style="flex:1;margin-left:6px;padding:10px 12px;border:none;border-radius:8px;background:linear-gradient(90deg,#00e676,#00b0ff);color:#000;font-weight:700;cursor:pointer;">Confirm</button>
    </div>
  </div>
</div>

  <!-- Spinner (loading animation) -->
  <div id="spinner" class="hidden" style="margin-top:18px;">
    <div style="width:44px;height:44px;border-radius:50%;border:6px solid #222;border-top:6px solid #00e676; animation:spin 1s linear infinite;margin:0 auto"></div>
    <div style="margin-top:10px;color:#aaa;font-size:13px">Loading Tap Arena‚Ä¶</div>
  </div>
  
  

  <!-- Game UI -->
  <div id="gamePage" class="hidden" style="width:100%;display:flex;flex-direction:column;align-items:center;">

    <!-- Glass terminal -->
    <div id="tapTerminal" class="glass-terminal" aria-live="polite">
      <div class="terminal-header">TAP TERMINAL</div>

      <div class="terminal-line">
        <div>‚è± Time Left</div>
        <div><span id="timer">60</span>s</div>
      </div>

      <div class="terminal-line">
        <div>üëÜ Taps</div>
        <div><span id="tapCount">0</span></div>
      </div>

      <div class="terminal-line">
        <div>üíµ Earnings</div>
        <div>‚Ç¶<span id="earnings">0.00</span></div>
      </div>

      <div id="trainBarContainer" style="margin-top:10px;">
        <div id="trainBar" style="width:100%"></div>
      </div>

      <div class="stats-row" style="margin-top:10px">
        <div class="stat">
          <div class="label">BONUS LVL</div>
          <div class="value" id="bonusLevelVal">1</div>
        </div>
        <div class="stat">
          <div class="label">SPEED</div>
          <div class="value" id="speedVal">‚Äî</div>
        </div>
      </div>

      <div id="bonusContainer" style="margin-top:12px;">
        <div id="bonusBar"></div>
      </div>
    </div>

    <!-- TAP button -->
    <button id="tapButton" aria-label="Tap" title="Tap fast!">TAP</button>

    <!-- Mini stats -->
    <div id="miniStats" aria-hidden="false">Taps: <strong id="miniTapCount">0</strong> ¬∑ Earnings: ‚Ç¶<span id="miniEarnings">0.00</span></div>

    <!-- Result modal -->
<div id="resultModal" class="modal-backdrop" style="display:none;align-items:center;justify-content:center;">
  <div class="modal" style="padding:16px;border-radius:12px;max-width:380px;text-align:center;position:relative;">
    <button id="closeResult" style="position:absolute;top:8px;right:8px;font-size:18px;border:none;background:none;cursor:pointer;">‚úñ</button>
    <div id="resultMessage" style="margin-top:10px;font-size:16px;font-weight:600;"></div>
    <button id="playAgainBtn" style="margin-top:16px;padding:10px 16px;border-radius:8px;border:none;background:linear-gradient(90deg,#00e676,#00b0ff);color:#000;font-weight:800;cursor:pointer;">Play Again</button>
  </div>
</div>

  </div> <!-- end gamePage -->

  <!-- Fixed bottom profile + leaderboard button -->
  <div id="bottomBar" style="position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:90%;max-width:480px;display:flex;flex-direction:column;align-items:center;gap:6px;z-index:1000;">
    <div class="profile-card" style="background:rgba(255,255,255,0.04);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);text-align:center;">
      <div class="profile-name" id="profileName">GUEST 0000</div>
      <div class="profile-info">STARS COLLECTED: <span id="starCount">50</span>‚≠ê</div>
      <div class="profile-info">CASH EARNED: <span id="cashCount">0</span></div>
    </div>
    <button id="leaderboardBtn" style="padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,#FFD700,#FF8C00);color:#111;font-weight:800;border:none;cursor:pointer;font-size:14px;">View Leaderboard üèÜ</button>
  </div>

  <!-- Leaderboard modal -->
  <div id="leaderboardModal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Top Tappers ‚Äî This Hour</h3>
      <ol id="leaderboardList" class="list" style="list-style:none;padding-left:0;margin:0;"></ol>
      <div style="margin-top:12px;text-align:right;">
        <button id="closeLeaderboard" style="padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,#FF1493,#FF8C00);color:#fff;font-weight:800;cursor:pointer">Close</button>
      </div>
    </div>
  </div>

</div>

<!-- Audio -->
<audio id="tapSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs,
  doc, runTransaction, serverTimestamp, Timestamp, getDoc
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// ---------- FIREBASE CONFIG ----------
const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-S77BMC266C",
  databaseURL: "https://metaverse-1010-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ---------- DOM REFERENCES ----------
const DOM = {
  startBtn: document.getElementById('startBtn'),
  playModal: document.getElementById('playModal'),
  cancelPlay: document.getElementById('cancelPlay'),
  confirmPlay: document.getElementById('confirmPlay'),
  spinner: document.getElementById('spinner'),
  startPage: document.getElementById('startPage'),
  gamePage: document.getElementById('gamePage'),
  tapButton: document.getElementById('tapButton'),
  tapSound: document.getElementById('tapSound'),
  timerEl: document.getElementById('timer'),
  tapCountEl: document.getElementById('tapCount'),
  earningsEl: document.getElementById('earnings'),
  bonusBar: document.getElementById('bonusBar'),
  trainBar: document.getElementById('trainBar'),
  bonusLevelVal: document.getElementById('bonusLevelVal'),
  speedVal: document.getElementById('speedVal'),
  miniTapCount: document.getElementById('miniTapCount'),
  miniEarnings: document.getElementById('miniEarnings'),
  leaderboardBtn: document.getElementById('leaderboardBtn'),
  leaderboardModal: document.getElementById('leaderboardModal'),
  leaderboardList: document.getElementById('leaderboardList'),
  closeLeaderboard: document.getElementById('closeLeaderboard'),
  finalTapsEl: document.getElementById('finalTaps'),
  finalPlaceEl: document.getElementById('finalPlace'),
  playAgain: document.getElementById('playAgain'),
  posterImg: document.getElementById('posterImg'),
  starCountEl: document.getElementById('starCount'),
  profileNameEl: document.getElementById('profileName')
};

// ---------- GAME CONFIG ----------
const STAR_COST = 10;
const DAILY_INITIAL_POT = 10000;
const CASH_PER_AWARD = 1;
const SESSION_DURATION = 60;

// ---------- GAME STATE ----------
let taps = 0;
let earnings = 0;
let timer = SESSION_DURATION;
let bonusLevel = 1;
let progress = 0;
let tapsForNext = 100;
let running = false;
let intervalId = null;
let cashCounter = 0;
let cashThreshold = 0;
let currentUser = null;

// ---------- STORAGE KEYS ----------
const KEY_POT = 'moneytrain_pot';
const KEY_RESET_DAY = 'moneytrain_reset_day';
const KEY_HALF_DAY = 'moneytrain_half_date';

// ---------- HELPER FUNCTIONS ----------
function randomInt(min, max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getStoredPot(){ return parseInt(localStorage.getItem(KEY_POT)) || null; }
function setStoredPot(v){ localStorage.setItem(KEY_POT, Math.max(0, Math.floor(v))); }
function getPotResetDay(){ return localStorage.getItem(KEY_RESET_DAY) || null; }
function setPotResetDay(s){ localStorage.setItem(KEY_RESET_DAY, s); }

function initializePot(){
  const today = new Date().toISOString().slice(0,10);
  if (!getStoredPot() || getPotResetDay() !== today){
    setStoredPot(DAILY_INITIAL_POT);
    setPotResetDay(today);
    localStorage.setItem(KEY_HALF_DAY, '');
  }
}

async function loadCurrentUserForGame() {
  try {
    const vipRaw = localStorage.getItem('vipUser');
    const hostRaw = localStorage.getItem('hostUser');
    const storedUser = vipRaw ? JSON.parse(vipRaw) : hostRaw ? JSON.parse(hostRaw) : null;

    if (!storedUser?.uid) {
      currentUser = null;
      if (DOM.profileNameEl) DOM.profileNameEl.textContent = 'GUEST 0000';
      if (DOM.starCountEl) DOM.starCountEl.textContent = DOM.starCountEl.textContent || '50';
      return;
    }

    const snap = await getDoc(doc(db, 'users', storedUser.uid));
    currentUser = snap.exists() ? { uid: storedUser.uid, ...snap.data() } : {
      uid: storedUser.uid,
      chatId: storedUser.displayName || storedUser.email.split('@')[0],
      stars: 0,
      cash: 0,
      email: storedUser.email
    };

    if (DOM.profileNameEl) DOM.profileNameEl.textContent = currentUser.chatId || storedUser.displayName || storedUser.email.split('@')[0];
    if (DOM.starCountEl) DOM.starCountEl.textContent = String(currentUser.stars ?? 0);
  } catch (err) {
    console.warn('loadCurrentUserForGame error:', err);
    currentUser = null;
    if (DOM.profileNameEl) DOM.profileNameEl.textContent = 'GUEST 0000';
    if (DOM.starCountEl) DOM.starCountEl.textContent = DOM.starCountEl.textContent || '50';
  }
}

async function tryDeductStarsForJoin(cost) {
  if (!currentUser?.uid) return { ok:false, message:'You are not logged in' };
  try {
    await runTransaction(db, async t => {
      const u = await t.get(doc(db, 'users', currentUser.uid));
      if (!u.exists()) throw new Error('User not found');
      const currentStars = Number(u.data().stars || 0);
      if (currentStars < cost) throw new Error('Not enough stars');
      t.update(doc(db, 'users', currentUser.uid), { stars: currentStars - cost });
    });
    return { ok:true };
  } catch (e) { return { ok:false, message:e.message || 'Could not deduct stars' }; }
}

async function giveCashToUser(amount){
  if (!currentUser?.uid) {
    if (DOM.miniEarnings) DOM.miniEarnings.textContent = (parseFloat(DOM.miniEarnings.textContent||'0') + amount).toFixed(2);
    return { ok:true };
  }
  try {
    await runTransaction(db, async t => {
      const uRef = doc(db, 'users', currentUser.uid);
      const u = await t.get(uRef);
      if (!u.exists()) throw new Error('User not found');
      t.update(uRef, { cash: Number(u.data().cash || 0) + amount });
    });
    return { ok:true };
  } catch(e) { console.error('giveCashToUser error', e); return { ok:false, message:e.message }; }
}

function flashTapGlow(){
  DOM.tapButton.classList.add('tap-glow');
  setTimeout(()=> DOM.tapButton.classList.remove('tap-glow'), 120);
}

function radiateText(txt){
  const r = DOM.tapButton.getBoundingClientRect();
  const node = document.createElement('div');
  node.textContent = txt;
  Object.assign(node.style, {
    position:'fixed', left:`${r.left+r.width/2}px`, top:`${r.top+r.height/2}px`,
    transform:'translate(-50%,-50%)', pointerEvents:'none', zIndex:9999,
    fontWeight:'800', color:'#fff', textShadow:'0 0 8px rgba(0,0,0,0.6)',
    opacity:'1', transition:'transform .8s ease-out, opacity .8s ease-out'
  });
  document.body.appendChild(node);
  node.style.transform = `translate(${(Math.random()-0.5)*120}px,-120px)`;
  node.style.opacity = '0';
  setTimeout(()=> node.remove(), 900);
}

function updateUI(){
  if(DOM.timerEl) DOM.timerEl.textContent = String(timer);
  if(DOM.tapCountEl) DOM.tapCountEl.textContent = String(taps);
  if(DOM.earningsEl) DOM.earningsEl.textContent = earnings.toFixed(2);
  if(DOM.bonusBar) DOM.bonusBar.style.width = ((progress / tapsForNext) * 100) + '%';
  if(DOM.bonusLevelVal) DOM.bonusLevelVal.textContent = String(bonusLevel);
  if(DOM.speedVal) DOM.speedVal.textContent = (taps>0 && duration-timer>0) ? Math.round(taps / Math.max(1,duration-timer)) + '/s' : '‚Äî';
  if(DOM.miniTapCount) DOM.miniTapCount.textContent = String(taps);
  if(DOM.miniEarnings) DOM.miniEarnings.textContent = earnings.toFixed(2);
}

function stopSession(){ running=false; if(intervalId){ clearInterval(intervalId); intervalId=null; } }

async function endSession(){
  if(!running) return;
  stopSession();

  try { await addDoc(collection(db,'tapSessions'), {
    taps, earnings, uid: currentUser?.uid||null, username: currentUser?.chatId||DOM.profileNameEl?.textContent||'GUEST', timestamp: serverTimestamp()
  }); } catch(e){ console.error('Failed to save session', e); }

  let placeText='‚Äî';
  try {
    const oneHourAgo = Timestamp.fromDate(new Date(Date.now()-3600*1000));
    const snap = await getDocs(query(collection(db,'tapSessions'), where('timestamp','>',oneHourAgo), orderBy('taps','desc'), limit(50)));
    const arr = snap.docs.map(d=>d.data().taps||0);
    const all = arr.slice(); all.push(taps); all.sort((a,b)=>b-a);
    placeText = `#${all.indexOf(taps)+1}`;
  } catch(e){ console.warn('Could not compute place', e); }

  showEndGameModal({ username: currentUser?.chatId||DOM.profileNameEl?.textContent||'GUEST', taps, earnings:earnings.toFixed(2), place: placeText });
  DOM.tapButton.disabled = true;
}

function startSession(){
  taps=0; earnings=0; timer=SESSION_DURATION; bonusLevel=1; progress=0; tapsForNext=100; running=true; cashCounter=0; cashThreshold=randomInt(1,12);
  updateUI();
  if(DOM.trainBar) DOM.trainBar.style.width='100%';
  intervalId=setInterval(()=>{
    timer--; if(timer<0) timer=0; updateUI();
    if(DOM.trainBar) DOM.trainBar.style.width=Math.max(0,(timer/SESSION_DURATION)*100)+'%';
    if(timer===0) endSession();
  },1000);
}

// ---------- TAP HANDLER ----------
const tapEvent = ('ontouchstart' in window) ? 'touchstart':'click';
DOM.tapButton?.addEventListener(tapEvent, async e=>{
  e.preventDefault(); if(!running) return;
  taps++; progress++; cashCounter++;

  if(cashCounter>=cashThreshold){
    cashCounter=0; cashThreshold=randomInt(1,12);
    const pot = getStoredPot() ?? DAILY_INITIAL_POT;
    if(pot>0){
      earnings+=CASH_PER_AWARD; setStoredPot(Math.max(0,pot-CASH_PER_AWARD));
      await giveCashToUser(CASH_PER_AWARD);
      const texts=['+‚Ç¶1','Nice! +‚Ç¶1','Cha-ching +1','+1 Naira'];
      radiateText(texts[randomInt(0,texts.length-1)]);
    } else { radiateText('Pool empty'); }
  } else { const texts=['Tap','Nice','+1 tap','Good']; radiateText(texts[randomInt(0,texts.length-1)]); }

  if(progress>=tapsForNext){
    progress=0; bonusLevel++; tapsForNext=100+(bonusLevel-1)*50;
    showTempMessage('TAP PRO!');
  }

  flashTapGlow();
  try{ DOM.tapSound.currentTime=0; DOM.tapSound.play().catch(()=>{}); } catch(e){}
  if(navigator.vibrate) navigator.vibrate(12);
  updateUI();
});

// ---------- START FLOW ----------
function initGameUI(){
  DOM.startBtn?.addEventListener('click', async ()=>{
    if(!currentUser) await loadCurrentUserForGame();
    if(DOM.playModal) DOM.playModal.style.display='flex';
  });
  DOM.cancelPlay?.addEventListener('click', ()=>{ if(DOM.playModal) DOM.playModal.style.display='none'; });
  DOM.confirmPlay?.addEventListener('click', async ()=>{
    if(!currentUser) await loadCurrentUserForGame();
    if(!currentUser?.uid){ alert('User not found. Please log in again.'); return; }

    const r = await tryDeductStarsForJoin(STAR_COST);
    if(!r.ok){ alert(r.message||'Not enough stars'); return; }

    if(DOM.starCountEl) DOM.starCountEl.textContent=String(Math.max(0, parseInt(DOM.starCountEl.textContent||'0')-STAR_COST));
    if(DOM.playModal) DOM.playModal.style.display='none';
    if(DOM.posterImg) DOM.posterImg.style.display='none';
    if(DOM.startPage) DOM.startPage.style.display='none';
    if(DOM.spinner) DOM.spinner.classList.remove('hidden');

    setTimeout(()=>{ if(DOM.spinner) DOM.spinner.classList.add('hidden'); if(DOM.gamePage) DOM.gamePage.classList.remove('hidden'); startSession(); },700);
  });
}

// ---------- END GAME MODAL ----------
function showEndGameModal({ username, taps, earnings, place }){
  const existing=document.getElementById('tapEndModal'); if(existing) existing.remove();
  const modal=document.createElement('div'); modal.id='tapEndModal';
  Object.assign(modal.style,{position:'fixed',inset:0,display:'flex',alignItems:'center',justifyContent:'center',background:'rgba(0,0,0,0.6)',zIndex:99999,padding:'20px'});
  const box=document.createElement('div');
  Object.assign(box.style,{width:'92%',maxWidth:'420px',background:'#0f0f0f',borderRadius:'12px',padding:'18px',textAlign:'center',border:'1px solid rgba(255,255,255,0.06)'});
  const h=document.createElement('div'); h.style.fontWeight='800'; h.style.color='#FF1493'; h.style.marginBottom='8px'; h.textContent=`${username}, Time's Up!`;
  const p1=document.createElement('div'); p1.style.margin='8px 0'; p1.innerHTML=`You earned <strong>‚Ç¶${earnings}</strong> and made <strong>${taps}</strong> taps.`;
  const p2=document.createElement('div'); p2.style.margin='8px 0'; p2.innerHTML=`Your rank: <strong>${place}</strong>`;
  const actions=document.createElement('div'); Object.assign(actions.style,{marginTop:'12px',display:'flex',justifyContent:'center',gap:'12px'});
  const playAgainBtn=document.createElement('button'); playAgainBtn.textContent='Play Again';
  Object.assign(playAgainBtn.style,{padding:'10px 14px',borderRadius:'8px',border:'none',cursor:'pointer',background:'linear-gradient(90deg,#00e676,#00b0ff)',color:'#000',fontWeight:800});
  const closeBtn=document.createElement('button'); closeBtn.textContent='Close';
  Object.assign(closeBtn.style,{padding:'10px 14px',borderRadius:'8px',border:'none',cursor:'pointer',background:'linear-gradient(90deg,#FF1493,#FF8C00)',color:'#fff',fontWeight:800});
  actions.append(playAgainBtn,closeBtn); box.append(h,p1,p2,actions); modal.appendChild(box); document.body.appendChild(modal);
  playAgainBtn.addEventListener('click', ()=>{ modal.remove(); DOM.tapButton.disabled=false; startSession(); });
  closeBtn.addEventListener('click', ()=>{ modal.remove(); if(DOM.gamePage) DOM.gamePage.classList.add('hidden'); if(DOM.startPage) DOM.startPage.style.display='flex'; if(DOM.posterImg) DOM.posterImg.style.display='block'; DOM.tapButton.disabled=false; });
}

// ---------- TEMP MESSAGE ----------
function showTempMessage(txt){
  const msg=document.createElement('div'); msg.textContent=txt;
  Object.assign(msg.style,{position:'fixed',left:'50%',top:'30%',transform:'translateX(-50%)',background:'#000',padding:'10px 16px',borderRadius:'8px',border:'1px solid rgba(255,255,255,0.06)',zIndex:9999});
  document.body.appendChild(msg);
  setTimeout(()=>{ msg.style.transition='opacity .4s'; msg.style.opacity=0; setTimeout(()=>msg.remove(),400); },900);
}

// ---------- LEADERBOARD ----------
DOM.leaderboardBtn?.addEventListener('click', async ()=>{
  DOM.leaderboardList.innerHTML='<li style="color:#aaa">Loading‚Ä¶</li>';
  DOM.leaderboardModal.style.display='flex';
  try{
    const oneHourAgo=Timestamp.fromDate(new Date(Date.now()-3600*1000));
    const snap=await getDocs(query(collection(db,'tapSessions'), where('timestamp','>',oneHourAgo), orderBy('taps','desc'), limit(20)));
    DOM.leaderboardList.innerHTML=snap.empty ? '<li style="color:#aaa">No scores this hour</li>' :
      snap.docs.map((d,i)=>{const data=d.data(); return `<li style="padding:8px 6px;border-bottom:1px dashed rgba(255,255,255,0.03)"><strong>#${i+1}</strong> ‚Äî ${data.username||'GUEST'} ‚Äî ${data.taps||0} taps &nbsp; (‚Ç¶${(data.earnings||0).toFixed(2)}) <div style="font-size:11px;color:#aaa">${data.timestamp?.toDate?.().toLocaleTimeString()||''}</div></li>`}).join('');
  } catch(e){ DOM.leaderboardList.innerHTML='<li style="color:#f88">Failed to load</li>'; console.error(e); }
});
DOM.closeLeaderboard?.addEventListener('click', ()=> DOM.leaderboardModal.style.display='none');
DOM.leaderboardModal?.addEventListener('click', e=>{ if(e.target===DOM.leaderboardModal) DOM.leaderboardModal.style.display='none'; });

// ---------- STYLING ----------
const style=document.createElement('style');
style.innerHTML=`#tapButton.tap-glow{box-shadow:0 0 26px rgba(0,230,118,0.9),0 0 8px rgba(0,176,255,0.6);transform:scale(1.03);}`;
document.head.appendChild(style);

// ---------- INIT ----------
initializePot();
loadCurrentUserForGame();
initGameUI();
document.addEventListener('gesturestart', e=>e.preventDefault(), {passive:false});
document.body.addEventListener('touchstart', ()=>{ DOM.tapSound?.play().catch(()=>{}); }, {once:true});

// ---------- DEBUG HELPERS ----------
window.tapMasterDebug = { getPot:getStoredPot, setPot:setStoredPot, startSession, endSession };
</script>
</body>
</html>