<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Multi-Room Chat Test</title>
<style>
  body {background:#000;color:#fff;font-family:sans-serif;margin:0;padding:0;}
  #messages {height:300px;overflow-y:auto;border:1px solid #333;padding:5px;margin:5px;}
  #messageInput {width:70%;}
  #sendBtn {padding:5px 10px;}
  .msg {padding:3px;margin:2px;border-radius:4px;}
  .msg.me {background:rgba(255,20,147,0.3);}
  .msg.other {background:rgba(255,255,255,0.1);}
  #starCount {color:#FF1493;}
</style>
</head>
<body>

<h2 id="roomName"></h2>
<div>Stars: <span id="starCount">0</span></div>

<div id="messages"></div>

<input type="text" id="messageInput" placeholder="Type message...">
<button id="sendBtn">Send</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
      apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
      authDomain: "metaverse-1010.firebaseapp.com",
      projectId: "metaverse-1010",
      storageBucket: "metaverse-1010.firebasestorage.app",
      messagingSenderId: "1044064238233",
      appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
      measurementId: "G-S77BMC266C",
      databaseURL: "https://metaverse-1010-default-rtdb.firebaseio.com/"
    };
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
setPersistence(auth, browserLocalPersistence);

const urlParams = new URLSearchParams(window.location.search);
const roomId = urlParams.get("room") || "lobby";
document.getElementById("roomName").innerText = "Room: " + roomId;

let currentUser = null;
let roomData = {};

// Mock room settings (star cost + private mode + host/admins)
const roomSettings = {
  lobby: { costPerMessage: 0, private: false, hostId:null, adminIds:[] },
  vip: { costPerMessage: 1, private: false, hostId:null, adminIds:[] },
  privateRoom: { costPerMessage:0, private:true, hostId:"hostUID", adminIds:["adminUID1","adminUID2"] }
};

// ------------------- Auth -------------------
const provider = new GoogleAuthProvider();
if(!auth.currentUser){
  signInWithPopup(auth,provider).catch(console.error);
}

onAuthStateChanged(auth, async (user) => {
  if(!user) return;
  currentUser = user;

  const userRef = doc(db, "users", currentUser.uid);
  const userSnap = await getDoc(userRef);
  if(!userSnap.exists()) await setDoc(userRef, {stars:5,cash:0,chatId:"GUEST"+Math.floor(Math.random()*9999)});

  onSnapshot(userRef, docSnap => {
    const d = docSnap.data();
    document.getElementById("starCount").innerText = d.stars;
    currentUser.stars = d.stars;
  });

  // Load room settings (private mode, host/admins)
  roomData = roomSettings[roomId] || { costPerMessage:0, private:false, hostId:null, adminIds:[] };

  // Listen to messages
  const messagesQuery = query(
    collection(db, roomData.private?"privateMessages":"messages"),
    where("roomId","==",roomId),
    orderBy("timestamp","asc")
  );
  onSnapshot(messagesQuery, snapshot => {
    const messagesDiv = document.getElementById("messages");
    messagesDiv.innerHTML = "";
    snapshot.forEach(doc => {
      const m = doc.data();
      const div = document.createElement("div");
      div.classList.add("msg");
      if(m.senderId === currentUser.uid) div.classList.add("me");
      else div.classList.add("other");

      // If private room, show only if user is host/admin/sender
      if(roomData.private){
        const isHost = currentUser.uid === roomData.hostId;
        const isAdmin = roomData.adminIds.includes(currentUser.uid);
        if(!isHost && !isAdmin && m.senderId !== currentUser.uid) return;
      }

      div.textContent = m.senderName + ": " + m.content;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });

  // Send message button
  document.getElementById("sendBtn").onclick = async () => {
    const input = document.getElementById("messageInput");
    const msg = input.value.trim();
    if(!msg) return;

    // Check stars if room charges
    if(currentUser.stars < roomData.costPerMessage){
      alert("Not enough stars to send message!");
      return;
    }

    if(roomData.costPerMessage>0){
      const userRef = doc(db,"users",currentUser.uid);
      await updateDoc(userRef,{stars:currentUser.stars-roomData.costPerMessage});
      currentUser.stars -= roomData.costPerMessage;
    }

    await addDoc(collection(db, roomData.private?"privateMessages":"messages"),{
      content: msg,
      senderId: currentUser.uid,
      senderName: currentUser.displayName || "GUEST",
      roomId: roomId,
      timestamp: serverTimestamp()
    });

    input.value="";
  }
});
</script>
</body>
</html>