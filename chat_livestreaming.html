<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi ‚Äî Live Stream üí∏</title>
<style>
body{margin:0;font-family:sans-serif;color:#fff;background:#000;}
#appWrapper{display:flex;justify-content:center;width:100%;height:100vh;}
.app{display:flex;flex-direction:column;width:100%;max-width:480px;height:100%;padding:10px;gap:8px;}
.brand{color:#FF1493;font-weight:700;font-size:24px;text-align:center;}
#helloText{font-size:20px;font-weight:800;text-align:center;margin:6px 0;color:#fff;opacity:0;}
@keyframes helloFade {0%{opacity:0; transform:scale(0.95);}50%{opacity:1; transform:scale(1);}100%{opacity:0; transform:scale(0.95);}}
#helloText.animate{animation:helloFade 2s ease-in-out infinite;}
#messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.msg{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);}
.msg.me{background:rgba(255,20,147,0.06);}
.send-area{display:flex;gap:6px;position:sticky;bottom:10px;}
.send-area input{flex:1;padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);background:#111;color:#fff;}
.send-btn{padding:8px 14px;border-radius:999px;background:#FF1493;color:#000;border:0;cursor:pointer;}
.buzz-btn{padding:8px 12px;border-radius:999px;background:#1d1d1d;color:#FF1493;cursor:pointer;border:1px solid rgba(255,20,147,0.18);}
.profile{display:none;flex-direction:column;gap:8px;margin-top:10px;}
.profile-name{font-weight:800;color:#fff;}
.profile-value{font-family:monospace;color:#fff;}
</style>
</head>
<body>
<div id="appWrapper">
  <div class="app">
    <div class="brand">‰πÇ‰∏®‰πÇ‰∏®</div>
    <div id="helloText">HELLO</div>

    <div id="messages"></div>

    <div class="send-area" id="sendArea" style="display:none;">
      <input type="text" id="messageInput" placeholder="Type message..." />
      <button id="buzzBtn" class="buzz-btn">üö®</button>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>

    <div class="profile" id="profileBox">
      <div class="profile-name" id="profileName">Guest 0000</div>
      <div>Stars: <span class="profile-value" id="starCount">0</span> ‚≠êÔ∏è</div>
      <div>Cash: ‚Ç¶<span class="profile-value" id="cashCount">0</span></div>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getFirestore, collection, doc, getDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.firebasestorage.app",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-S77BMC266C"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
const CHAT_COLLECTION = "messages_livestreaming";

// HELLO animation
setTimeout(()=>{ document.getElementById("helloText").classList.add("animate"); }, 500);

// Sign in function (simplified)
async function signIn(){
  const provider = new GoogleAuthProvider();
  try{
    const result = await signInWithPopup(auth, provider);
    currentUser = result.user;
    document.getElementById("sendArea").style.display="flex";
    document.getElementById("profileBox").style.display="flex";
    document.getElementById("profileName").textContent=currentUser.displayName||"Guest";
    initUser();
  }catch(err){ console.error(err); }
}
signIn();

// Initialize user doc if not exists
async function initUser(){
  const userRef = doc(db,"users",currentUser.uid);
  const snap = await getDoc(userRef);
  if(!snap.exists()){
    await setDoc(userRef,{stars:0,cash:0,isAdmin:false});
  }
  listenMessages();
  listenStats();
}

// Listen messages
function listenMessages(){
  const q = query(collection(db,CHAT_COLLECTION), orderBy("timestamp","asc"));
  onSnapshot(q,(snap)=>{
    const messagesEl=document.getElementById("messages");
    messagesEl.innerHTML="";
    snap.docs.forEach(d=>{
      const m=d.data();
      const div=document.createElement("div");
      div.className="msg"+(m.uid===currentUser.uid?" me":"");
      div.textContent=(m.chatId||"Guest")+": "+(m.content||"");
      messagesEl.appendChild(div);
    });
    messagesEl.scrollTop=messagesEl.scrollHeight;
  });
}

// Listen user stars/cash
function listenStats(){
  const userRef = doc(db,"users",currentUser.uid);
  onSnapshot(userRef,(snap)=>{
    const data=snap.exists()?snap.data():{stars:0,cash:0};
    document.getElementById("starCount").textContent=(data.stars||0).toLocaleString();
    document.getElementById("cashCount").textContent=(data.cash||0).toLocaleString();
  });
}

// Send message
document.getElementById("sendBtn").addEventListener("click", async ()=>{
  const txt=document.getElementById("messageInput").value.trim();
  if(!txt) return;
  await addDoc(collection(db,CHAT_COLLECTION),{
    content: txt,
    uid: currentUser.uid,
    chatId: currentUser.displayName||"Guest",
    timestamp: serverTimestamp()
  });
  document.getElementById("messageInput").value="";
});

// BUZZ
document.getElementById("buzzBtn").addEventListener("click", async ()=>{
  const userRef = doc(db,"users",currentUser.uid);
  const snap = await getDoc(userRef);
  const stars = snap.exists()?snap.data().stars||0:0;
  if(stars<1){ alert("Not enough stars to BUZZ!"); return; }
  await addDoc(collection(db,CHAT_COLLECTION),{
    content:"BUZZ üö®",
    uid:currentUser.uid,
    chatId:currentUser.displayName||"Guest",
    timestamp:serverTimestamp()
  });
  await updateDoc(userRef,{stars:increment(-1)});
});
</script>
</body>
</html>