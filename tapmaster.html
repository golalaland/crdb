<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, maximum-scale=1.0, user-scalable=no" />
<title>Tap Master Online</title>
<style>
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#0e0e0e;color:#fff;
       touch-action:manipulation;overflow:hidden;text-align:center}
  h1{color:#00e676;text-shadow:0 0 10px #00e67666;margin-top:40px}
  button{border:none;cursor:pointer}
  #startPage{height:100vh;background:url('https://via.placeholder.com/600x1000?text=Tap+Master+Image')center/cover no-repeat;
             display:flex;flex-direction:column;align-items:center;justify-content:center}
  #startBtn{margin-top:300px;padding:15px 40px;font-size:22px;font-weight:bold;
            background:linear-gradient(90deg,#00e676,#00b0ff);color:#000;border-radius:10px}
  footer{position:absolute;bottom:20px;width:100%;font-size:14px;opacity:.7}
  #modal,#spinner,#resultModal{position:fixed;inset:0;background:rgba(0,0,0,.8);
                               display:none;align-items:center;justify-content:center;flex-direction:column}
  .modal-box{background:#1e1e1e;padding:25px;border-radius:12px;width:80%;max-width:320px}
  .modal-box button{margin:10px;padding:10px 25px;font-weight:bold;border-radius:8px}
  .loader{border:6px solid #333;border-top:6px solid #00e676;border-radius:50%;
          width:60px;height:60px;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #gamePage{display:none;flex-direction:column;align-items:center;justify-content:space-between;
            height:100vh;padding:20px;box-sizing:border-box}
  #bonusContainer{width:280px;height:22px;background:#333;border-radius:12px;
                  overflow:hidden;margin:20px auto 10px;box-shadow:0 0 10px #00e67644}
  #bonusBar{height:100%;width:0;background:linear-gradient(90deg,#00e676,#00b0ff);
            transition:width .2s}
  #tapButton{width:150px;height:150px;border-radius:50%;
             background:radial-gradient(circle at top left,#00e676,#00b0ff);
             font-size:22px;font-weight:bold;color:#000;box-shadow:0 0 25px #00e676aa;
             animation:pulse 1.5s infinite}
  @keyframes pulse{0%{box-shadow:0 0 10px #00e67666;transform:scale(1)}
                   50%{box-shadow:0 0 25px #00e676cc;transform:scale(1.05)}
                   100%{box-shadow:0 0 10px #00e67666;transform:scale(1)}}
  #tapButton:active{transform:scale(.95)}
  .floatText{position:absolute;color:#00ff95;font-weight:bold;font-size:20px;opacity:0;
             animation:floatUp .8s ease-out forwards}
  @keyframes floatUp{0%{opacity:1;transform:translate(0,0)}
                     100%{opacity:0;transform:translate(var(--x,0px),-80px)}}
  .confetti{position:fixed;width:8px;height:8px;background:var(--color);
            top:50%;left:50%;opacity:.9;animation:confettiFall 1s ease-out forwards}
  @keyframes confettiFall{to{transform:translate(var(--x),var(--y)) rotate(720deg);opacity:0}}
  @keyframes fadeOut{to{opacity:0;transform:translate(-50%,-60%) scale(1.2)}}
  #leaderboard{text-align:left;width:90%;max-width:320px;margin:auto}
  #leaderboard ol{padding-left:20px}
</style>
</head>
<body>

<div id="startPage">
  <h1>TAP MASTER ONLINE</h1>
  <button id="startBtn">Play</button>
  <footer>¬© 2025 Tap Master Studios</footer>
</div>

<div id="modal">
  <div class="modal-box">
    <p>Play <b>Tap Master</b> for <b>200‚≠ê</b>?</p>
    <button id="yesBtn">Yes</button><button id="noBtn">Cancel</button>
  </div>
</div>

<div id="spinner"><div class="loader"></div><p>Loading Tap Arena‚Ä¶</p></div>

<div id="gamePage">
  <div>
    <p>‚è± Time Left: <span id="timer">60</span>s</p>
    <p>üëÜ Taps: <span id="tapCount">0</span></p>
    <p>üíµ Earnings: ‚Ç¶<span id="earnings">0.00</span></p>
  </div>
  <div id="bonusContainer"><div id="bonusBar"></div></div>
  <button id="tapButton">TAP</button>
  <div id="leaderboard">
    <h3>üèÜ Top Tappers (This Hour)</h3>
    <ol id="scores"></ol>
  </div>
</div>

<div id="resultModal">
  <div class="modal-box">
    <h2>Time‚Äôs Up!</h2>
    <p>üëÜ Taps: <span id="finalTaps">0</span></p>
    <p>üíµ Cash Earned: ‚Ç¶<span id="finalEarnings">0.00</span></p>
    <button id="playAgain">Play Again</button>
  </div>
</div>

<audio id="tapSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<!-- Firebase SDKs -->
<script type="module">
import {
  initializeApp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getFirestore, collection, addDoc,
  query, where, orderBy, limit, getDocs,
  serverTimestamp, Timestamp
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// üî• your config ‚Üì
const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.appspot.com",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-S77BMC266C",
  databaseURL: "https://metaverse-1010-default-rtdb.firebaseio.com/"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.addEventListener("DOMContentLoaded", () => {

  // -------- ELEMENTS ----------
  const startPage = document.getElementById('startPage');
  const modal = document.getElementById('modal');
  const spinner = document.getElementById('spinner');
  const gamePage = document.getElementById('gamePage');
  const resultModal = document.getElementById('resultModal');
  const startBtn = document.getElementById('startBtn');
  const yesBtn = document.getElementById('yesBtn');
  const noBtn = document.getElementById('noBtn');
  const playAgain = document.getElementById('playAgain');
  const tapButton = document.getElementById('tapButton');
  const tapSound = document.getElementById('tapSound');
  const timerEl = document.getElementById('timer');
  const tapCountEl = document.getElementById('tapCount');
  const earningsEl = document.getElementById('earnings');
  const bonusBar = document.getElementById('bonusBar');
  const finalTapsEl = document.getElementById('finalTaps');
  const finalEarningsEl = document.getElementById('finalEarnings');
  const scoresEl = document.getElementById('scores');

  let taps = 0, earnings = 0, timer = 60, interval;
  let bonusLevel = 1, progress = 0, tapsForNext = 100;

  // Unlock audio early for iOS autoplay
  document.body.addEventListener("touchstart", () => {
    tapSound.play().catch(() => {});
  }, { once: true });

  // ---------- START FLOW ----------
  startBtn.addEventListener("click", () => modal.style.display = "flex");
  noBtn.addEventListener("click", () => modal.style.display = "none");

  yesBtn.addEventListener("click", () => {
    modal.style.display = "none";
    spinner.style.display = "flex";
    setTimeout(() => {
      spinner.style.display = "none";
      startGame();
    }, 1200);
  });

  function startGame() {
    taps = 0; earnings = 0; timer = 60;
    bonusLevel = 1; progress = 0; tapsForNext = 100;

    startPage.style.display = "none";
    resultModal.style.display = "none";
    gamePage.style.display = "flex";

    updateStats();
    loadTop5();

    interval = setInterval(() => {
      timer--;
      timerEl.textContent = timer;

      if (timer <= 0) {
        endGame();
      }
    }, 1000);
  }

  // ---------- TAP HANDLER ----------
  // Faster: combine click + touchstart
  const tapEvent = ("ontouchstart" in window) ? "touchstart" : "click";

  tapButton.addEventListener(tapEvent, (e) => {
    e.preventDefault();
    if (timer <= 0) return;

    taps++;
    earnings++;
    tapCountEl.textContent = taps;
    earningsEl.textContent = earnings.toFixed(2);

    tapSound.currentTime = 0;
    tapSound.play().catch(() => {});

    if (navigator.vibrate) navigator.vibrate(15);

    // ----- FLOAT TEXT -----
    const f = document.createElement('div');
    f.className = 'floatText';
    f.textContent = '+‚Ç¶1.00';
    const r = tapButton.getBoundingClientRect();
    const x = (Math.random() - 0.5) * 80;
    f.style.setProperty("--x", `${x}px`);
    f.style.left = (r.left + r.width / 2) + "px";
    f.style.top = (r.top + r.height / 2) + "px";
    document.body.appendChild(f);
    setTimeout(() => f.remove(), 800);

    // ----- BONUS BAR -----
    progress++;
    if (progress >= tapsForNext) {
      progress = 0;
      bonusLevel++;
      tapsForNext = 100 + (bonusLevel - 1) * 50;
      showTapPro();
    }
    bonusBar.style.width = (progress / tapsForNext * 100) + "%";
  });

  // ---------- TAP PRO ----------
  function showTapPro() {
    confettiBurst();
    const msg = document.createElement('div');
    msg.textContent = "TAP PRO!";
    Object.assign(msg.style, {
      position: "fixed",
      top: "50%", left: "50%",
      transform: "translate(-50%,-50%)",
      fontSize: "48px",
      fontWeight: "bold",
      color: "#00e676",
      textShadow: "0 0 20px #00e676",
      animation: "fadeOut 2s forwards",
      zIndex: 2000
    });
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2000);
  }

  function confettiBurst() {
    for (let i = 0; i < 30; i++) {
      const c = document.createElement("div");
      c.classList.add("confetti");
      c.style.setProperty("--color", `hsl(${Math.random() * 360},100%,60%)`);
      c.style.setProperty("--x", `${(Math.random() - 0.5) * 600}px`);
      c.style.setProperty("--y", `${(Math.random() - 0.5) * 400}px`);
      document.body.appendChild(c);
      setTimeout(() => c.remove(), 900);
    }
  }

  function updateStats() {
    timerEl.textContent = timer;
    tapCountEl.textContent = taps;
    earningsEl.textContent = earnings.toFixed(2);
    bonusBar.style.width = "0%";
  }

  // ---------- END GAME ----------
  async function endGame() {
    clearInterval(interval);
    gamePage.style.display = "none";
    resultModal.style.display = "flex";

    finalTapsEl.textContent = taps;
    finalEarningsEl.textContent = earnings.toFixed(2);

    try {
      await addDoc(collection(db, "tapSessions"), {
        taps,
        earnings,
        timestamp: serverTimestamp()
      });
    } catch (err) {
      console.error("Save failed", err);
    }

    loadTop5();
  }

  playAgain.addEventListener("click", () => {
    resultModal.style.display = "none";
    startPage.style.display = "flex";
  });

  // ---------- LOAD TOP 5 ----------
  async function loadTop5() {
    const oneHourAgo = Timestamp.fromDate(new Date(Date.now() - 3600000));

    const q = query(
      collection(db, "tapSessions"),
      where("timestamp", ">", oneHourAgo),
      orderBy("timestamp", "desc"),  // SAFE
      orderBy("taps", "desc"),
      limit(5)
    );

    const snap = await getDocs(q);

    scoresEl.innerHTML = snap.docs
      .map((doc, i) => {
        const s = doc.data();
        return `<li>#${i + 1} ‚Äî ${s.taps} taps (‚Ç¶${(s.earnings || 0).toFixed(2)})</li>`;
      })
      .join("");
  }

});
</script>
</body>
</html>