<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Live Streaming Chat</title>
  <style>
    body {
      margin:0; font-family:sans-serif; background:#111; color:#fff;
      display:flex; flex-direction:column; height:100vh;
    }
    #auth, #chatroom { display:none; }
    #auth.active, #chatroom.active { display:block; }
    #messages {
      flex:1; overflow-y:auto; padding:10px;
    }
    .msg { margin:4px 0; padding:6px 10px; border-radius:6px; background:#222; }
    .msg.me { background:#333; }
    .msg.highlight { background:#ff0; color:#000; font-weight:bold; box-shadow:0 0 10px #ff0; }
    .meta { font-size:0.8em; margin-right:6px; }
    #chatControls {
      display:flex; padding:10px; background:#000;
    }
    #chatControls input {
      flex:1; padding:8px; border:none; border-radius:4px;
    }
    #chatControls button {
      margin-left:6px; padding:8px 12px; border:none; border-radius:4px;
      cursor:pointer; font-weight:bold;
    }
    #topbar {
      display:flex; justify-content:space-between; align-items:center;
      padding:8px 12px; background:rgba(255,255,255,0.08);
      backdrop-filter:blur(6px); border-bottom:1px solid rgba(255,255,255,0.2);
    }
    #starPopup {
      position:fixed; top:10px; left:50%; transform:translateX(-50%);
      background:#222; padding:10px 18px; border-radius:6px;
      border:1px solid #555; display:none; z-index:1000;
    }
  </style>
</head>
<body>
  <div id="auth" class="active">
    <button id="googleSignInBtn">Sign in with Google</button>
  </div>

  <div id="chatroom">
    <div id="topbar">
      <div>Stars: <span id="starCount">0</span> | Cash: â‚¦<span id="cashCount">0</span></div>
      <div>
        <button id="buzzBtn">BUZZ ðŸš¨</button>
        <button id="tipBtn">TIP ðŸ’¸</button>
        <button id="redeemBtn">Redeem</button>
      </div>
    </div>
    <div id="messages"></div>
    <div id="chatControls">
      <input id="messageInput" placeholder="Type a message..."/>
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <div id="starPopup"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---------------- FIREBASE CONFIG ----------------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // ---------------- AUTH ----------------
    document.getElementById("googleSignInBtn").addEventListener("click", async ()=>{
      const provider = new GoogleAuthProvider();
      try { await signInWithPopup(auth, provider); } 
      catch(err){ alert(err.message); }
    });

    onAuthStateChanged(auth, async user=>{
      if(user){
        currentUser = user;
        document.getElementById("auth").classList.remove("active");
        document.getElementById("chatroom").classList.add("active");
        const userRef = doc(db,"users",user.uid);
        const snap = await getDoc(userRef);
        if(!snap.exists()){
          await setDoc(userRef,{stars:20,cash:0,chatId:user.displayName||"Guest"});
          currentUser.stars = 20;
          currentUser.cash = 0;
          currentUser.chatId = user.displayName||"Guest";
        } else {
          const d=snap.data();
          currentUser.stars=d.stars||0;
          currentUser.cash=d.cash||0;
          currentUser.chatId=d.chatId||user.displayName||"Guest";
        }
        updateUI();
      } else {
        document.getElementById("auth").classList.add("active");
        document.getElementById("chatroom").classList.remove("active");
      }
    });

    function updateUI(){
      document.getElementById("starCount").textContent=currentUser.stars;
      document.getElementById("cashCount").textContent=currentUser.cash;
    }
    function showStarPopup(msg){
      const el=document.getElementById("starPopup");
      el.textContent=msg; el.style.display="block";
      setTimeout(()=>el.style.display="none",2000);
    }

    function generateGuestName(){ return "Guest"+Math.floor(Math.random()*1000); }

    function getColorForUser(name){
      const colors=["#f66","#6f6","#66f","#ff6","#6ff","#f6f","#fff"];
      let hash=0;
      for(let i=0;i<name.length;i++) hash=name.charCodeAt(i)+((hash<<5)-hash);
      return colors[Math.abs(hash)%colors.length];
    }

    // ---------------- FIRESTORE MESSAGES ----------------
    const messagesDiv = document.getElementById("messages");
    const messagesQuery = query(collection(db,"messages_livestreaming"), orderBy("timestamp","asc")); 

    onSnapshot(messagesQuery, snap=>{
      messagesDiv.innerHTML="";
      snap.forEach(doc=>{
        const m=doc.data();
        const div=document.createElement("div");
        div.classList.add("msg");
        if(currentUser && m.uid===currentUser.uid) div.classList.add("me");
        if(m.highlight) div.classList.add("highlight");
        const color=getColorForUser(m.chatId||"Guest");
        div.innerHTML=`<span class="meta" style="color:${color}">${m.chatId||"Guest"}:</span> <span class="content">${m.content}</span>`;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });

    document.getElementById("sendBtn").addEventListener("click", async ()=>{
      const val=document.getElementById("messageInput").value.trim();
      if(!val) return;
      document.getElementById("messageInput").value="";
      await addDoc(collection(db,"messages_livestreaming"),{
        content:val,
        uid:currentUser.uid,
        chatId:currentUser.chatId||generateGuestName(),
        timestamp:serverTimestamp(),
        highlight:false
      });
    });

    document.getElementById("buzzBtn").addEventListener("click", async ()=>{
      if(currentUser.stars<10){
        showStarPopup("Not enough stars to create a BUZZ! ðŸš¨");
        return;
      }
      const val=document.getElementById("messageInput").value.trim();
      if(!val){
        showStarPopup("Type a message to BUZZ! ðŸš¨");
        return;
      }
      await updateDoc(doc(db,"users",currentUser.uid),{stars:currentUser.stars-10});
      currentUser.stars-=10; updateUI();
      await addDoc(collection(db,"messages_livestreaming"),{
        content:val,
        uid:currentUser.uid,
        chatId:currentUser.chatId||generateGuestName(),
        timestamp:serverTimestamp(),
        highlight:true
      });
      showStarPopup("BUZZ ðŸš¨ sent!");
      document.getElementById("messageInput").value="";
    });

    document.getElementById("tipBtn").addEventListener("click", ()=>{
      alert("TIP ðŸ’¸ clicked â€” placeholder for payment link.");
    });

    document.getElementById("redeemBtn").addEventListener("click", ()=>{
      alert("Redeem clicked â€” placeholder for cashout flow.");
    });

    // ---------------- STAR GENERATION ----------------
    setInterval(async ()=>{
      if(!currentUser) return;
      if(currentUser.stars<50){
        currentUser.stars++;
        await updateDoc(doc(db,"users",currentUser.uid),{stars:currentUser.stars});
        updateUI();
      }
    },60000);
  </script>
</body>
</html>