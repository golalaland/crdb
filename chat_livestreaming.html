<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Xixi ‚Äî Live Stream üí∏</title>
<style>
body{margin:0;font-family:sans-serif;color:#fff;background:#000;height:100vh;}
#appWrapper{display:flex;justify-content:center;width:100%;height:100%;}
.app{display:flex;flex-direction:column;width:100%;max-width:480px;height:100%;padding:10px;gap:8px;}
.brand{color:#FF1493;font-weight:700;font-size:24px;text-align:center;}
#helloText{font-size:20px;font-weight:800;text-align:center;margin:6px 0;color:#fff;opacity:0;}
@keyframes helloFade {0%{opacity:0; transform:scale(0.95);}50%{opacity:1; transform:scale(1);}100%{opacity:0; transform:scale(0.95);}}
#helloText.animate{animation:helloFade 2s ease-in-out infinite;}
#messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:6px;}
.msg{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);}
.msg.me{background:rgba(255,20,147,0.06);}
.send-area{display:flex;gap:6px;position:sticky;bottom:10px;}
.send-area input{flex:1;padding:8px;border-radius:999px;border:1px solid rgba(255,255,255,0.06);background:#111;color:#fff;}
.send-btn{padding:8px 14px;border-radius:999px;background:#FF1493;color:#000;border:0;cursor:pointer;}
.buzz-btn{padding:8px 12px;border-radius:999px;background:#1d1d1d;color:#FF1493;cursor:pointer;border:1px solid rgba(255,20,147,0.18);}
.profile{display:none;flex-direction:column;gap:8px;margin-top:10px;}
.profile-name{font-weight:800;color:#fff;}
.profile-value{font-family:monospace;color:#fff;}
/* BUZZ animation */
@keyframes buzzGlow {
  0% { box-shadow: 0 0 5px var(--glow-color); }
  50% { box-shadow: 0 0 15px var(--glow-color); }
  100% { box-shadow: 0 0 5px var(--glow-color); }
}
.buzz-content { border-radius: 8px; padding: 4px 6px; }
/* Star popup */
#starPopup{position:fixed;top:10%;left:50%;transform:translateX(-50%);padding:12px 18px;background:#FF1493;color:#000;border-radius:12px;display:none;z-index:9999;}
</style>
</head>
<body>

<div id="appWrapper">
  <div class="app">
    <div class="brand">‰πÇ‰∏®‰πÇ‰∏®</div>
    <div id="helloText">HELLO</div>

    <!-- Sign-In Button -->
    <button id="googleSignInBtn" class="send-btn">Sign in with Google</button>

    <div id="messages"></div>

    <div class="send-area" id="sendArea" style="display:none;">
      <input type="text" id="messageInput" placeholder="Type message..." />
      <button id="buzzBtn" class="buzz-btn">üö®</button>
      <button id="sendBtn" class="send-btn">Send</button>
    </div>

    <div class="profile" id="profileBox">
      <div class="profile-name" id="profileName">Guest 0000</div>
      <div>Stars: <span class="profile-value" id="starCount">0</span> ‚≠êÔ∏è</div>
      <div>Cash: ‚Ç¶<span class="profile-value" id="cashCount">0</span></div>
    </div>

  </div>
</div>

<!-- Star popup -->
<div id="starPopup"><span id="starText">Message</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, serverTimestamp, doc, updateDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-firestore.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.1/firebase-auth.js";

// ---------- Firebase config ----------
const firebaseConfig = {
  apiKey: "AIzaSyDbKz4ef_eUDlCukjmnK38sOwueYuzqoao",
  authDomain: "metaverse-1010.firebaseapp.com",
  projectId: "metaverse-1010",
  storageBucket: "metaverse-1010.firebasestorage.app",
  messagingSenderId: "1044064238233",
  appId: "1:1044064238233:web:2fbdfb811cb0a3ba349608",
  measurementId: "G-S77BMC266C"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// ---------- Elements ----------
const googleBtn = document.getElementById("googleSignInBtn");
const sendBtn = document.getElementById("sendBtn");
const buzzBtn = document.getElementById("buzzBtn");
const messageInputEl = document.getElementById("messageInput");
const messagesEl = document.getElementById("messages");
const helloEl = document.getElementById("helloText");
const profileBox = document.getElementById("profileBox");
const profileNameEl = document.getElementById("profileName");
const starCountEl = document.getElementById("starCount");
const cashCountEl = document.getElementById("cashCount");
const sendArea = document.getElementById("sendArea");

// ---------- Variables ----------
let currentUser = null;
const CHAT_COLLECTION = "messages_livestreaming";
const BUZZ_COST = 5;
const userColors = {};

// ---------- Utility ----------
function formatCash(n){ return n.toLocaleString("en-US"); }
function randomColor(){ const colors = ["#FF1493","#FF69B4","#8A2BE2","#00BFA6","#FFA07A"]; return colors[Math.floor(Math.random()*colors.length)]; }
function showStarPopup(text){
  const popup = document.getElementById("starPopup");
  document.getElementById("starText").textContent = text;
  popup.style.display = "block";
  setTimeout(()=>popup.style.display="none",1500);
}

// ---------- HELLO Animation ----------
helloEl.classList.add("animate");

// ---------- Auth ----------
googleBtn.addEventListener("click", async e=>{
  e.preventDefault();
  try{
    const result = await signInWithPopup(auth, provider);
    currentUser = result.user;
  } catch(err){
    console.error("Sign in failed:", err);
    showStarPopup("Sign in failed!");
  }
});

onAuthStateChanged(auth, async user=>{
  if(user){
    currentUser = user;
    profileBox.style.display = "flex";
    sendArea.style.display = "flex";
    profileNameEl.textContent = user.displayName || "GUEST";

    const userRef = doc(db, "users", user.uid);
    const snap = await getDoc(userRef);
    if(snap.exists()){
      const data = snap.data();
      starCountEl.textContent = data.stars || 0;
      cashCountEl.textContent = formatCash(data.cash || 0);
    }
  } else {
    profileBox.style.display = "none";
    sendArea.style.display = "none";
    profileNameEl.textContent = "GUEST";
  }
});

// ---------- Load messages ----------
const messagesQuery = query(collection(db, CHAT_COLLECTION), orderBy("timestamp","asc"));
onSnapshot(messagesQuery, snapshot=>{
  messagesEl.innerHTML = "";
  snapshot.forEach(docSnap=>{
    const m = docSnap.data();
    const wrapper = document.createElement("div");
    wrapper.className = "msg";
    if(m.uid === currentUser?.uid) wrapper.classList.add("me");

    const meta = document.createElement("span");
    meta.className = "meta";
    meta.textContent = m.chatId || "Guest";
    meta.style.color = (m.uid && userColors[m.uid]) ? userColors[m.uid] : "#ffffff";

    const content = document.createElement("span");
    if(m.highlight || m.buzzColor){
      content.className = "buzz-content content";
      content.style.background = m.buzzColor || randomColor();
      content.style.color = "#000";

      if(!m.glowEnded){
        const glowColor = m.buzzColor || randomColor();
        const duration = (1 + Math.random()*1.5) + "s";
        content.style.setProperty("--glow-color", glowColor);
        content.style.animation = `buzzGlow ${duration} infinite`;

        setTimeout(async ()=>{
          content.style.animation = "";
          try{
            const msgRef = doc(db, CHAT_COLLECTION, docSnap.id);
            await updateDoc(msgRef,{glowEnded:true});
          } catch(e){ console.warn(e); }
        }, m.buzzDuration || 60000);
      }

    } else {
      content.className = "content";
      content.textContent = m.content || "";
    }

    wrapper.appendChild(meta);
    wrapper.appendChild(content);
    messagesEl.appendChild(wrapper);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
});

// ---------- Send message ----------
sendBtn.addEventListener("click", async ()=>{
  if(!currentUser){ showStarPopup("Sign in to send messages"); return; }
  const txt = messageInputEl.value.trim();
  if(!txt){ showStarPopup("Type a message first"); return; }

  try{
    await addDoc(collection(db, CHAT_COLLECTION), {
      content: txt,
      uid: currentUser.uid,
      chatId: currentUser.displayName || "Guest",
      timestamp: serverTimestamp(),
      highlight:false,
      glowEnded:true
    });
    messageInputEl.value = "";
  } catch(err){ console.error(err); showStarPopup("Failed to send message"); }
});

// ---------- BUZZ button ----------
buzzBtn.addEventListener("click", async ()=>{
  if(!currentUser){ showStarPopup("Sign in to BUZZ"); return; }

  const userRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(userRef);
  const data = snap.exists() ? snap.data() : {};
  const stars = data.stars || 0;

  if(stars < BUZZ_COST){ showStarPopup("Not enough stars to BUZZ!"); return; }
  const txt = messageInputEl.value.trim();
  if(!txt){ showStarPopup("Type a message to BUZZ!"); return; }

  try{
    await updateDoc(userRef, { stars: increment(-BUZZ_COST) });

    const glowColor = randomColor();
    await addDoc(collection(db, CHAT_COLLECTION), {
      content: txt,
      uid: currentUser.uid,
      chatId: currentUser.displayName || "Guest",
      timestamp: serverTimestamp(),
      highlight:true,
      buzzColor: glowColor,
      buzzDuration:60000,
      glowEnded:false
    });
    messageInputEl.value = "";
    showStarPopup("BUZZ sent!");
  } catch(err){ console.error(err); showStarPopup("Failed to send BUZZ"); }
});

// ---------- Enter key ----------
messageInputEl.addEventListener("keypress", e=>{
  if(e.key === "Enter") sendBtn.click();
});
</script>
</body>
</html>